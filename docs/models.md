# Models

This file explains the different standardized model classes that are used throughout the OPACA LLM. Most of these classes are located in the file [models.py](../Backend/src/models.py).

### AgentMessage

#### Description

The Agent Message is used as the standard response model each time an LLM Agent is invoked. It holds different information pertaining to the LLM invocation.

#### Attributes
| Attribute           | Type             | Default | Description                                                       |
|---------------------|------------------|---------|-------------------------------------------------------------------|
| `agent`             | `str`            |         | The name of the agent.                                            |
| `content`           | `str`            |         | The text output this agent has generated.                         |
| `tools`             | `List[Any]`      | `[]`    | A list of optional tools that were generated by this agent.       |
| `response_metadata` | `Dict[str, Any]` | `{}`    | A object containing additional information regarding token usage. |
| `execution_time`    | `float`          | `.0`    | The total time it took for this agent to generate its output.     |

### Response

#### Description

The final response that will be sent back to the frontend. Contains a list of `AgentMessages` that were generated during the response generation.

#### Attributes
| Attribute        | Type                 | Default | Description                                                                                     |
|------------------|----------------------|---------|-------------------------------------------------------------------------------------------------|
| `query`          | `str`                | `""`    | The original user query that was sent to the backend.                                           |
| `agent_messages` | `List[AgentMessage]` | `[]`    | A list of agent messages that were created during the course of the response generation.        |
| `iterations`     | `int`                | `0`     | The total number of internal iterations that were executed before returning the final response. |
| `execution_time` | `float`              | `.0`    | The total execution time it took for the selected method to generate an answer.                 |
| `content`        | `str`                | `""`    | The generated response that will be shown to the user.                                          |
| `error`          | `str`                | `""`    | An optional output for any error messages that were generated.                                  |

### SessionData

#### Description

Stores user specific data related to a single browser session.

#### Attributes
| Attribute       | Type             | Default | Description                                                                                                                                                                                                                      |
|-----------------|------------------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `messages`      | `List[Any]`      | `[]`    | Saves message pairs consisting of the original user input and the generated output. Is used as a message history in all subsequent requests.                                                                                     |
| `config`        | `Dict[str, Any]` | `{}`    | Stores the configuration setting for each available method. The method names are the keys for the different configuration objects. (Example: `{"tool-llm-llama": {"model": ...}}`                                                |
| `opaca_client`  | `OpacaClient`    | `None`  | A personal proxy client. The client is initialized with the given user credentials and authenticated. Every action invocation by a user is subsequently performed by using this client and therefore the associated permissions. |
| `api_key`       | `str`            | `None`  | An optional api key to be used for model access instead of keys stored in the environment variables.                 |                                                                                   
| `cached_models` | `Dict[str, Any]` | `{}`    | Caches pre-initialized models to improve inference speed. Models are stored based on their base_url. For gpt models use value "gpt", for all others their base url as the key.                                                   |
| `uploaded_files`  | `Dict[str, Dict[str, Any]]` | `{}`    | Each PDF is stored as a dictionary with:<br>- `"content"`: a BytesIO object containing the file's binary data<br>- `"content_type"`: the MIME type of the file<br>- `"sent"`: a boolean indicating if the file has been uploaded to OpenAI<br>- `"file_id"`: the string ID assigned by OpenAI after successful upload |

### Message

#### Description

Is used as the expected body argument in the `/{backend}/query` endpoints

#### Attributes
| Attribute    | Type  | Default | Description                                                                  |
|--------------|-------|---------|------------------------------------------------------------------------------|
| `user_query` | `str` |         | The query a user has input into the OPACA LLM ChatBot.                       |
| `api_key`    | `str` | `""`    | An optional API key used instead of keys found in the environment variables. |

### Url

#### Description

Is used as the expected body argument in the `/connect` endpoint.

#### Attributes
| Attribute | Type        | Default | Description                                                                                                                                |
|-----------|-------------|---------|--------------------------------------------------------------------------------------------------------------------------------------------|
| `url`     | `str`       |         | The base url to be used for every interaction with the OPACA platform.                                                                     |
| `user`    | `str\|None` |         | The user name to authenticate against the connected OPACA platform. Only relevant if the connected OPACA platform requires authentication. |
| `pwd`     | `str\|None` |         | The password used in combination with the given user name. Only relevant if the connected OPACA platform requires authentication.          |

### ConfigArrayItem

#### Description

Defines the schema of an array item. Mainly used in connection with `ConfigParameter`.

#### Attributes

| Attribute     | Type                        | Default | Description                                                                                                                   |
|---------------|-----------------------------|---------|-------------------------------------------------------------------------------------------------------------------------------|
| `type`        | `str`                       |         | The type of all the items the array contains. (This forbids the usage of multiple types within the same array of a parameter) |
| `array_items` | `Optional[ConfigArrayItem]` | `None`  | If the array nested (`type` is `array`) defines the data types of the items of the nested arrays.                             |

### ChatMessage

#### Description

Represents single messages that are generated during the invocation of the OPACA-LLM. Can be stored as a list to be given as messages to a model during invocation.

#### Attributes

| Attribute | Type  | Default | Description                                                                                      |
|-----------|-------|---------|--------------------------------------------------------------------------------------------------|
| `role`    | `str` |         | Role for the message. Can be 'system', 'assistant', 'user', 'function', 'tool', and 'developer'. |
| `content` | `str` |         | The content of the message.                                                                      |


### ConfigParameter

#### Description

Defines the schema for a configuration parameter.

#### Attributes
| Attribute     | Type                        | Default | Description                                                                   |
|---------------|-----------------------------|---------|-------------------------------------------------------------------------------|
| `type`        | `str`                       |         | The data type of the configuration parameter.                                 |
| `required`    | `bool`                      |         | Whether the parameter is required or not.                                     |
| `default`     | `Any`                       |         | The default value of the parameter.                                           |
| `array_items` | `Optional[ConfigArrayItem]` | `None`  | Specifies the type of the array items, if `type` is set to `array`.           |
| `description` | `Optional[str]`             | `None`  | An optional description of the parameter.                                     |
| `minimum`     | `Optional[int]`             | `None`  | Only for types `integer` or `number`. Defines a minimum limit for the number. |
| `maximum`     | `Optional[int]`             | `None`  | Only for types `integer` or `number`. Defines a maximum limit for the number. |
| `enum`        | `Optional[List[Any]]`       | `None`  | If set, defines all available values the parameter can have.                  |

#### Methods

`validate_after(self: Self)`

- Description: Uses the `@model_validator` decorator of Pydantic. Check upon initialization for the following constraints:
  - If the type is `array`, the `array_items` field has to be set.
  - If a `minimum` or `maximum` was set, the type has to be either `integer` or `number`.
  - If `enum` was set, the `default` field has to be part of `enum`.
  - If both fields `minimum` and `maximum` were set, the `maximum` value has to be larger or equal to the `minimum` value.

`type_validator(value: str)`

- Description: Checks if the given type is part of: `["integer", "number", "string", "boolean", "array", "object", "null"]`

### ConfigPayload

#### Description

Stores the actual values of a given configuration and the schema that is defined in `ConfigParameter`.

#### Attributes

| Attribute       | Type                         | Default | Description                                                                                   |
|-----------------|------------------------------|---------|-----------------------------------------------------------------------------------------------|
| `value`         | `Any`                        |         | Should be a JSON storing the actual values of parameters in the format `{"key": value}`       |
| `config_schema` | `Dict[str, ConfigParameter]` |         | A JSON holding the configuration schema definition. Must include the same keys as in `value`  |
